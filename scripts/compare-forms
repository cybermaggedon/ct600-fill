#!/usr/bin/env python3

"""
Compare two CT600 PDF forms and extract field label positions.

Extracts the box number labels (e.g., "1", "2", "30", "145") from both
old and new CT600 PDFs, compares their positions, and outputs:
  - Fields that haven't moved
  - Fields that shifted position (with delta)
  - Fields that moved to a different page
  - New fields only in the new form
  - Removed fields only in the old form

Coordinate system: millimeters from bottom-left of page (matching spec.json).
"""

import pdfplumber
import json
import sys
import os
import re
from collections import defaultdict

# All known CT600 box numbers (from spec.json + new ones in 2025 form)
KNOWN_BOX_NUMBERS = set([
    1, 2, 3, 4, 5, 6, 7, 8,
    30, 35, 40, 45, 50, 55, 60, 65, 70, 75,
    80, 85, 90, 95, 96, 100, 105, 110, 115, 120, 125, 130, 135, 140,
    141, 142, 143, 144, 145, 150, 155, 160, 165, 170, 172,
    175, 180, 185, 190, 195, 200, 205,
    210, 215, 220, 225, 230, 235, 240, 245, 250, 255, 260,
    263, 265, 275, 280, 285, 290, 295, 300, 305, 310, 312, 315, 320, 325,
    326, 327, 328, 329, 330, 335, 340, 345, 350, 355, 360, 365, 370, 375,
    380, 385, 390, 395, 400, 405, 410, 415, 420, 425,
    430, 435, 440, 445, 450, 455, 460, 465, 470,
    471, 472, 473, 474, 475, 480, 485, 490, 495, 496, 497,
    500, 501, 502, 505, 510, 515, 520, 525, 526, 527, 528,
    530, 535, 540, 541, 545, 550, 555, 560, 565, 570, 575, 580,
    585, 586, 590, 595, 600, 605, 610, 614, 615,
    616, 617, 618, 620, 625, 630, 631, 635, 640, 645, 647,
    650, 653, 655, 656, 657, 658, 659, 660, 663, 665, 670, 675, 680, 685,
    688, 689, 690, 691, 692, 693, 694, 695, 700, 705, 710, 711,
    713, 714, 715, 720, 721, 722, 723, 724, 725, 726, 727, 730,
    733, 734, 735, 736, 737, 738, 740, 741, 742, 743, 744, 745,
    746, 747, 748, 749, 750, 751, 752, 755,
    760, 765, 770, 771, 772, 773, 775,
    780, 785, 790, 795, 800, 805, 810, 815, 820, 825, 830, 835,
    840, 845, 850, 855,
    856, 857, 858, 860, 865, 870, 875, 880, 885, 886, 890, 895,
    900, 905, 910, 915, 920, 925, 930, 935, 940, 943, 945, 950, 955,
    960, 965, 970, 975, 980, 985, 986, 987,
])

# Points to mm conversion
PT_TO_MM = 25.4 / 72.0


def extract_field_labels(pdf_path):
    """
    Extract box number label positions from a CT600 PDF.

    Returns dict: {box_number: (page_index, x_mm, y_mm)} where coords
    are in mm from bottom-left (matching spec.json coordinate system).

    The box number labels in CT600 forms are small numbers in teal boxes
    on the left margin. We identify them by:
    1. Extracting all text words with positions
    2. Filtering for numbers that match known box numbers
    3. Keeping only labels on the left side of the page (x < 100mm typically)
       or that appear at expected positions
    """
    fields = {}
    ambiguous = defaultdict(list)

    with pdfplumber.open(pdf_path) as pdf:
        for page_idx, page in enumerate(pdf.pages):
            page_height = page.height  # in points

            words = page.extract_words(
                x_tolerance=2,
                y_tolerance=2,
                keep_blank_chars=False,
                extra_attrs=["fontname", "size"],
            )

            for word in words:
                text = word["text"].strip()

                # Check if this is a pure integer matching a known box number
                if not re.match(r'^\d+$', text):
                    continue

                num = int(text)
                if num not in KNOWN_BOX_NUMBERS:
                    continue

                # Convert coordinates: pdfplumber uses top-left origin in points
                # spec.json uses bottom-left origin in mm
                x_mm = word["x0"] * PT_TO_MM
                # Use bottom of text for y (closer to baseline)
                y_mm = (page_height - word["bottom"]) * PT_TO_MM

                # Font size - labels tend to be small-medium (7-11pt)
                font_size = word.get("size", 10)

                # Store all candidates - we'll disambiguate later
                ambiguous[num].append({
                    "page": page_idx,
                    "x_mm": round(x_mm, 1),
                    "y_mm": round(y_mm, 1),
                    "font_size": round(font_size, 1),
                    "fontname": word.get("fontname", ""),
                    "raw_x0": word["x0"],
                    "raw_top": word["top"],
                    "raw_bottom": word["bottom"],
                })

    # Disambiguate: for each box number, pick the label occurrence.
    # The box number labels in CT600 are typically:
    # - In a bold/specific font
    # - On the left side of the page
    # - Small font size
    # When there are multiple matches, prefer the one that looks like a label

    for num, candidates in ambiguous.items():
        if len(candidates) == 1:
            c = candidates[0]
            fields[num] = (c["page"], c["x_mm"], c["y_mm"])
        else:
            # Multiple candidates - try to find the label
            # Labels are typically on the left (x < 80mm) or in specific positions
            # and in smaller font sizes
            # For the tax calculation table (330-425), labels can be at various positions

            # Sort by: leftmost position, then smallest font
            scored = []
            for c in candidates:
                # Prefer leftmost position (labels are on the left)
                # Prefer smaller font (labels are typically 7-9pt)
                score = c["x_mm"] + c["font_size"] * 2
                scored.append((score, c))

            scored.sort(key=lambda x: x[0])
            best = scored[0][1]
            fields[num] = (best["page"], best["x_mm"], best["y_mm"])

    return fields


def compare_forms(old_path, new_path):
    """Compare field positions between old and new CT600 forms."""

    print(f"Extracting labels from OLD form: {old_path}")
    old_fields = extract_field_labels(old_path)
    print(f"  Found {len(old_fields)} field labels")

    print(f"Extracting labels from NEW form: {new_path}")
    new_fields = extract_field_labels(new_path)
    print(f"  Found {len(new_fields)} field labels")

    all_nums = sorted(set(old_fields.keys()) | set(new_fields.keys()))

    # Categorize
    unchanged = []
    shifted = []
    page_moved = []
    new_only = []
    old_only = []

    for num in all_nums:
        if num in old_fields and num in new_fields:
            o_page, o_x, o_y = old_fields[num]
            n_page, n_x, n_y = new_fields[num]

            if o_page != n_page:
                page_moved.append((num, old_fields[num], new_fields[num]))
            elif abs(o_x - n_x) < 1.0 and abs(o_y - n_y) < 1.0:
                unchanged.append((num, old_fields[num]))
            else:
                dx = n_x - o_x
                dy = n_y - o_y
                shifted.append((num, old_fields[num], new_fields[num], dx, dy))
        elif num in new_fields:
            new_only.append((num, new_fields[num]))
        else:
            old_only.append((num, old_fields[num]))

    # Report
    print("\n" + "=" * 70)
    print("COMPARISON REPORT")
    print("=" * 70)

    print(f"\n--- UNCHANGED ({len(unchanged)} fields) ---")
    print("Fields where position hasn't moved (< 1mm):")
    for num, (page, x, y) in unchanged:
        print(f"  Box {num:4d}: page {page}, ({x:6.1f}, {y:6.1f})")

    print(f"\n--- SHIFTED ({len(shifted)} fields) ---")
    print("Fields that moved on the same page:")
    for num, (o_page, o_x, o_y), (n_page, n_x, n_y), dx, dy in shifted:
        print(f"  Box {num:4d}: page {o_page}, "
              f"({o_x:6.1f}, {o_y:6.1f}) -> ({n_x:6.1f}, {n_y:6.1f})  "
              f"delta=({dx:+.1f}, {dy:+.1f})")

    print(f"\n--- PAGE MOVED ({len(page_moved)} fields) ---")
    print("Fields that moved to a different page:")
    for num, (o_page, o_x, o_y), (n_page, n_x, n_y) in page_moved:
        print(f"  Box {num:4d}: page {o_page} -> {n_page}, "
              f"({o_x:6.1f}, {o_y:6.1f}) -> ({n_x:6.1f}, {n_y:6.1f})")

    print(f"\n--- NEW FIELDS ({len(new_only)} fields) ---")
    print("Fields only in the new form:")
    for num, (page, x, y) in new_only:
        print(f"  Box {num:4d}: page {page}, ({x:6.1f}, {y:6.1f})")

    print(f"\n--- REMOVED FIELDS ({len(old_only)} fields) ---")
    print("Fields only in the old form:")
    for num, (page, x, y) in old_only:
        print(f"  Box {num:4d}: page {page}, ({x:6.1f}, {y:6.1f})")

    # Output machine-readable comparison
    comparison = {
        "old_pdf": old_path,
        "new_pdf": new_path,
        "old_labels": {str(k): list(v) for k, v in old_fields.items()},
        "new_labels": {str(k): list(v) for k, v in new_fields.items()},
        "unchanged": [num for num, _ in unchanged],
        "shifted": [
            {"box": num, "old": list(old), "new": list(new), "dx": dx, "dy": dy}
            for num, old, new, dx, dy in shifted
        ],
        "page_moved": [
            {"box": num, "old": list(old), "new": list(new)}
            for num, old, new in page_moved
        ],
        "new_only": [
            {"box": num, "pos": list(pos)} for num, pos in new_only
        ],
        "old_only": [
            {"box": num, "pos": list(pos)} for num, pos in old_only
        ],
    }

    return comparison


if __name__ == "__main__":

    base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

    old_pdf = os.path.join(base_dir, "CT600.pdf")
    new_pdf = os.path.join(base_dir, "CT600-new.pdf")

    if len(sys.argv) >= 3:
        old_pdf = sys.argv[1]
        new_pdf = sys.argv[2]

    comparison = compare_forms(old_pdf, new_pdf)

    # Save JSON output
    out_path = os.path.join(base_dir, "comparison.json")
    with open(out_path, "w") as f:
        json.dump(comparison, f, indent=2)
    print(f"\nFull comparison saved to: {out_path}")
